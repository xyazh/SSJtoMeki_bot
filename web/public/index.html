<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>QQ 机器人 · 后台管理</title>
    <link rel="shortcut icon" href="./images/favicon.png">
    <!-- 使用 layui（与用户现有代码兼容） -->
    <link rel="stylesheet" href="./layui/css/layui.css">
    <style>
        body {
            background: #f5f7fa;
            margin: 0;
            font-family: "Microsoft Yahei", Arial, sans-serif
        }

        .top-bar {
            height: 60px;
            background: #fff;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 1px 0 rgba(0, 0, 0, .06)
        }

        .logo {
            height: 36px;
            margin-right: 12px
        }

        .app-title {
            font-size: 18px;
            color: #333;
            margin-right: 20px
        }

        .side {
            width: 240px;
            background: #fff;
            height: calc(100vh - 60px);
            box-shadow: 1px 0 0 rgba(0, 0, 0, .03);
            position: fixed;
            top: 60px;
            left: 0;
            overflow: auto
        }

        .content {
            margin-left: 260px;
            padding: 20px;
            min-height: calc(100vh - 60px)
        }

        .card {
            background: #fff;
            padding: 16px;
            border-radius: 6px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, .03);
        }

        .menu-item {
            padding: 12px 18px;
            cursor: pointer;
            color: #333
        }

        .menu-item.active {
            background: #edf2ff;
            color: #2f54eb
        }

        .toolbar {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .small {
            font-size: 13px
        }

        textarea {
            min-height: 120px
        }

        .muted {
            color: #999
        }

        .flex {
            display: flex;
            gap: 12px
        }

        .grow {
            flex: 1
        }

        .table-actions button {
            margin-right: 6px
        }

        .footer-note {
            font-size: 12px;
            color: #999;
            margin-top: 12px
        }

        .stat-card {
            flex: 1 1 180px;
            /* 最小宽度180px，可扩展 */
            display: flex;
            align-items: center;
            gap: 12px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-info strong {
            display: block;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .muted.small {
            color: #888;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <img class="logo" src="./images/favicon.png" alt="logo">
        <div class="app-title">XYA QQ 机器人 · 管理后台</div>
        <div style="flex:1"></div>
        <div class="toolbar">
        </div>
    </div>

    <div class="side">
        <div class="menu-item active" data-view="dashboard">仪表盘</div>
        <div class="menu-item" data-view="messages">消息管理</div>
        <div class="menu-item" data-view="groups">群组管理</div>
        <div class="menu-item" data-view="send">发送测试/广播</div>
        <div class="menu-item" data-view="rules">规则</div>
    </div>

    <div class="content">
        <!-- 仪表盘 -->
        <div id="view_dashboard" class="view card" style="padding:16px;">
            <h3 style="margin-bottom:12px;">仪表盘</h3>
            <div class="flex" style="gap:12px; flex-wrap:wrap;">
                <!-- 在线状态 -->
                <div class="card stat-card">
                    <div class="stat-info">
                        <strong id="stat_online_bot">机器人在线：--</strong>
                        <div class="muted small">当前连接状态</div>
                    </div>
                </div>

                <!-- 状态 -->
                <div class="card stat-card">
                    <div class="stat-info">
                        <strong id="stat_status">状态：--</strong>
                        <div class="muted small">机器人状态</div>
                    </div>
                </div>

                <!-- 重连码 -->
                <div class="card stat-card">
                    <div class="stat-info">
                        <strong id="stat_recode">重连码：--</strong>
                        <div class="muted small">上次重连记录</div>
                    </div>
                </div>

                <!-- 情况 -->
                <div class="card stat-card">
                    <div class="stat-info">
                        <strong id="stat_good">情况：--</strong>
                        <div class="muted small">情况</div>
                    </div>
                </div>

                <!-- 消息计数 -->
                <div class="card stat-card grow">
                    <div class="stat-info">
                        <strong id="stat_msgs">收到消息：--</strong>
                        <div class="muted small">最近的消息计数</div>
                    </div>
                </div>
            </div>
        </div>


        <!-- 消息管理 -->
        <div id="view_messages" class="view" style="display:none">
            <h3>消息管理</h3>
            <div class="card" style="margin-top:12px">
                <div style="margin-bottom:8px;display:flex;align-items:center;gap:8px">
                    <input type="text" id="q_msg" placeholder="按关键字搜索" class="layui-input" style="width:320px">
                    <button class="layui-btn layui-btn-sm" id="btn_search_msg">搜索</button>

                </div>
                <table class="layui-table">
                    <thead>
                        <tr>
                            <th style="width:60px">ID</th>
                            <th style="width:100px">用户</th>
                            <th style="max-width:400px; word-break:break-word;">内容</th>
                            <th style="width:140px">时间</th>
                            <th style="width:120px">操作</th>
                        </tr>
                    </thead>
                    <tbody id="msg_table_body">
                        <!-- 动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 群组管理 -->
        <div id="view_groups" class="view" style="display:none">
            <h3>群组管理</h3>
            <div class="card" style="margin-top:12px">
                <div style="display:flex;gap:8px;align-items:center">
                    <button class="layui-btn" id="btn_fetch_groups">获取群组</button>
                    <button class="layui-btn layui-btn-danger" id="btn_leave_group">退群（选中）</button>
                </div>
                <table class="layui-table" style="margin-top:8px">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="group_select_all"></th>
                            <th>群号</th>
                            <th>群名</th>
                            <th>人数</th>
                            <th>启用状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="groups_table_body"></tbody>
                </table>
            </div>
        </div>


        <!-- 发送测试/广播 -->
        <div id="view_send" class="view" style="display:none">
            <h3>发送测试 / 广播 (发送文件可能会有延迟，请勿连续点击)</h3>
            <div class="card" style="margin-top:12px">
                <div class="layui-form-item">
                    <label class="layui-form-label">目标</label>
                    <div class="layui-input-block"><input class="layui-input" id="send_target"
                            placeholder="例如：123456789 或 group:987654"></div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">消息</label>
                    <div class="layui-input-block"><textarea class="layui-textarea" id="send_message"
                            placeholder="请输入要发送的文本消息，支持 CQ 码"></textarea></div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">附件</label>
                    <div class="layui-input-block" style="display:flex;gap:8px;align-items:center;">
                        <input type="file" id="send_file" accept="image/*,audio/*,video/*">
                        <select id="send_mode" class="layui-select">
                            <option value="image_sticker">图片 → 表情</option>
                            <option value="audio_voice">音频 → 语音</option>
                            <option value="video_video">视频 → 视频</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                    <button class="layui-btn" id="btn_send_once">发送</button>
                    <button class="layui-btn layui-btn-warm" id="btn_send_broadcast">广播（批量）</button>
                </div>
                <div id="send_result" class="footer-note"></div>
            </div>
        </div>


        <!-- 自动回复规则 -->
        <div id="view_rules" class="view" style="display:none">
            <h3>自动回复规则</h3>
            <div class="card" style="margin-top:12px">
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                    <button class="layui-btn" id="btn_fetch_rules">获取规则</button>
                    <button class="layui-btn layui-btn-normal" id="btn_add_rule">新增规则</button>
                    <button class="layui-btn layui-btn-danger" id="btn_delete_selected">删除（选中）</button>
                </div>
                <table class="layui-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="rule_select_all"></th>
                            <th>关键词 / 触发条件</th>
                            <th>回复内容</th>
                            <th>匹配模式</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="rules_table_body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="./js/jquery-2.1.4.min.js"></script>
    <script src="./layui/layui.js"></script>
    <script>
        // 简单前端逻辑：视图切换 / 调用后端 API（需要服务端实现对应接口）
        $(function () {
            // 菜单切换
            $('.menu-item').click(function () {
                $('.menu-item').removeClass('active');
                $(this).addClass('active');
                var view = $(this).data('view');
                $('.view').hide();
                $('#view_' + view).show();
            });

            // 加载消息列表
            $('#btn_refresh_msg, #btn_search_msg').click(loadMessages);
            function loadMessages() {
                var q = $('#q_msg').val() || '';
                $.get('/api/messages', { q: q }, function (res) {
                    var html = '';
                    (res || []).forEach(function (m, idx) {
                        html += '<tr>' +
                            '<td>' + m.id + '</td>' +
                            '<td>' + m.user + '</td>' +
                            '<td style="max-width:400px;word-break:break-word;overflow-wrap:break-word;">' + m.text + '</td>' +
                            '<td>' + m.time + '</td>' +
                            '<td class="table-actions">';
                        if (m.urls && m.urls.length > 0) {
                            html += '<div>';
                            m.urls.forEach(function (url, i) {
                                html += '<a href="javascript:;" class="copy-url" data-url="' + url + '" ' +
                                    'style="color:#52c41a;margin-right:5px;display:inline-block;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" ' +
                                    'title="' + url + '">复制链接</a>';
                            });
                            html += '</div>';
                        }
                        html += '</td></tr>';
                    });
                    $('#msg_table_body').html(html);
                    // 绑定点击事件
                    $('.copy-url').off('click').on('click', function () {
                        var url = $(this).data('url');
                        navigator.clipboard.writeText(url).then(function () {
                            layer.msg('已复制链接', { icon: 1 });
                        }).catch(function () {
                            layer.msg('复制失败', { icon: 2 });
                        });
                    });
                }).fail(function () {
                    layer.msg('获取消息失败', { icon: 0 });
                });
            }


            // 获取群组
            $('#btn_fetch_groups').click(function () {
                $.get('/api/groups', function (res) {
                    var html = '';
                    (res || []).forEach(function (g) {
                        const statusText = g.enabled ? '<span style="color:green">启用</span>' : '<span style="color:red">禁用</span>';
                        html += '<tr>' +
                            '<td><input type="checkbox" class="group_check" value="' + g.id + '"></td>' +
                            '<td>' + g.id + '</td>' +
                            '<td>' + g.name + '</td>' +
                            '<td>' + g.count + '</td>' +
                            '<td>' + statusText + '</td>' +
                            '<td><button class="layui-btn layui-btn-xs" onclick="openGroup(' + g.id + ')">管理</button></td>' +
                            '</tr>';
                    });
                    $('#groups_table_body').html(html);
                }).fail(function () { layer.msg('获取群列表失败', { icon: 0 }); });
            });

            $('#group_select_all').on('change', function () {
                $('.group_check').prop('checked', this.checked);
            });

            $('#btn_leave_group').click(function () {
                const selected = $('#groups_table_body input[type=checkbox]:checked')
                    .map((_, el) => $(el).val())
                    .get();
                if (selected.length === 0) {
                    return layer.msg('请先选择要退出的群组');
                }
                layer.confirm('确认要退出选中的 ' + selected.length + ' 个群组吗？', function (index) {
                    $.ajax({
                        url: '/api/groups/leave',
                        type: 'POST',
                        data: JSON.stringify({ group_ids: selected }),
                        contentType: 'application/json',
                        success: function (res) {
                            if (res.success) {
                                layer.msg('已退出所选群组');
                                $('#btn_fetch_groups').click();
                            } else {
                                layer.msg('部分退群失败：' + (res.error || '未知错误'));
                            }
                        },
                        error: function () {
                            layer.msg('网络错误，无法退群');
                        }
                    });
                    layer.close(index);
                });
            });
            window.openGroup = function (groupId) {
                // 获取群组详情
                $.get('/api/groups/data', { g: groupId }, function (g) {

                    // 构造表单 HTML
                    const formHtml = `
                        <form class="layui-form" style="margin:16px;">
                            <div class="layui-form-item">
                                <label class="layui-form-label">群号</label>
                                <div class="layui-input-block">
                                    <input type="text" value="${g.id}" readonly class="layui-input">
                                </div>
                            </div>

                            <div class="layui-form-item">
                                <label class="layui-form-label">启用状态</label>
                                <div class="layui-input-block">
                                    <input type="checkbox" id="group_enabled" lay-skin="switch" lay-text="启用|停用" ${g.enabled ? 'checked' : ''}>
                                </div>
                            </div>

                            <div class="layui-form-item" style="text-align:center;margin-top:20px;">
                                <button type="button" class="layui-btn" id="btn_save_group">保存设置</button>
                                <button type="button" class="layui-btn layui-btn-normal" id="btn_manage_members">成员管理</button>
                            </div>
                        </form>
                    `;

                    // 打开弹窗
                    layer.open({
                        type: 1,
                        title: '群组设置 - ' + g.id,
                        area: ['420px', '400px'],
                        content: formHtml,
                        success: function (layero, index) {
                            layui.form.render();
                            // 保存群设置
                            $('#btn_save_group').click(function () {
                                const updated = {
                                    id: g.id,
                                    enabled: $('#group_enabled').is(':checked')
                                };

                                $.ajax({
                                    url: '/api/groups/update',
                                    type: 'POST',
                                    data: JSON.stringify(updated),
                                    contentType: 'application/json',
                                    success: function (res) {
                                        if (res.success) {
                                            layer.msg('已保存群组设置');
                                            layer.close(index);
                                            $('#btn_fetch_groups').click(); // 刷新表格
                                        } else {
                                            layer.msg('保存失败：' + (res.error || '未知错误'));
                                        }
                                    },
                                    error: function () {
                                        layer.msg('网络错误，无法保存');
                                    }
                                });
                            });

                            // 打开成员管理弹窗
                            $('#btn_manage_members').click(function () {
                                layer.msg("施工中");
                            });
                        }
                    });

                }).fail(function () {
                    layer.msg('获取群组详情失败');
                });
            };


            $('#btn_send_once').click(function () {
                const target = $('#send_target').val().trim();
                const message = $('#send_message').val().trim();
                const file = $('#send_file')[0].files[0];
                const mode = $('#send_mode').val(); // 用户选择发送模式

                if (!target || (!message && !file)) {
                    return layer.msg('请填写目标或消息/选择文件');
                }

                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const base64Data = e.target.result;
                        const sendData = {
                            target: target,
                            message: message,
                            file: base64Data,
                            file_type: file.type,
                            send_mode: mode // 发送模式
                        };
                        sendToServer(sendData);
                    };
                    reader.readAsDataURL(file);
                } else {
                    sendToServer({ target, message, send_mode: 'text' });
                }
            });

            $('#btn_send_broadcast').click(function () {
                const message = $('#send_message').val().trim();
                const file = $('#send_file')[0].files[0];
                const mode = $('#send_mode').val(); // 用户选择发送模式

                if (!message && !file) {
                    return layer.msg('请填写目标或消息/选择文件');
                }

                // 二级确认弹窗
                layer.confirm(
                    '确定要向所有启用群聊发送这条广播吗？',
                    { icon: 3, title: '确认发送' },
                    function (index) {
                        // 用户点击确定后执行发送
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                const base64Data = e.target.result;
                                const sendData = {
                                    target: "all",
                                    message: message,
                                    file: base64Data,
                                    file_type: file.type,
                                    send_mode: mode // 发送模式
                                };
                                sendToServer(sendData);
                            };
                            reader.readAsDataURL(file);
                        } else {
                            sendToServer({
                                target: "all",
                                message,
                                send_mode: 'text'
                            });
                        }

                        layer.close(index); // 关闭确认框
                    }
                );
            });


            function sendToServer(data) {
                $.ajax({
                    url: '/api/send',
                    type: 'POST',
                    data: JSON.stringify(data),
                    contentType: 'application/json',
                    success: function (res) {
                        $('#send_result').append(`<div>发送到 ${data.target}：${res.success ? '成功' : '失败'}:${res.error}</div>`);
                    },
                    error: function () {
                        $('#send_result').append(`<div>发送到 ${data.target}：网络错误</div>`);
                    }
                });
            }


            function fetchStats() {
                $.get('/api/stats', function (res) {
                    // 机器人在线状态
                    $('#stat_online_bot').text('机器人在线：' + (res.online ? '是' : '否'));
                    // 收到消息总数
                    $('#stat_msgs').text('收到消息：' + (res.total || 0));
                    // 新增显示字段
                    $('#stat_status').text('状态：' + (res.status || '--'));
                    $('#stat_recode').text('重连码：' + (res.recode));
                    $('#stat_good').text('情况：' + (res.good));
                }).fail(function () {
                    $('#stat_online_bot').text('机器人在线：未知（请求失败）');
                    $('#stat_status').text('状态：未知');
                    $('#stat_recode').text('重连码：未知');
                    $('#stat_good').text('情况：未知');
                });
            }

            // 初次加载时执行一次
            fetchStats();
            // 每 5 秒轮询一次
            setInterval(fetchStats, 5000);



            // 获取规则列表
            function fetchRules() {
                $.get('/api/rules', function (res) {
                    var html = '';
                    (res || []).forEach(function (r) {
                        html += `
                <tr>
                    <td><input type="checkbox" class="rule_check" value="${r.id}"></td>
                    <td>${r.trigger}</td>
                    <td>${r.reply}</td>
                    <td>${r.mode === 'exact' ? '精确匹配' : '模糊匹配'}</td>
                    <td>${r.enabled ? '启用' : '停用'}</td>
                    <td>
                        <button class="layui-btn layui-btn-xs" onclick="editRule('${r.id}')">编辑</button>
                    </td>
                </tr>`;
                    });
                    $('#rules_table_body').html(html);
                }).fail(() => layer.msg('获取规则失败', { icon: 0 }));
            }

            $('#btn_fetch_rules').click(fetchRules);
            $('#rule_select_all').on('change', function () {
                $('.rule_check').prop('checked', this.checked);
            });

            // 删除选中规则
            $('#btn_delete_selected').click(function () {
                const selected = $('.rule_check:checked').map((_, el) => $(el).val()).get();
                if (selected.length === 0) return layer.msg('请选择要删除的规则');
                layer.confirm('确认删除选中的 ' + selected.length + ' 条规则？', function (index) {
                    $.ajax({
                        url: '/api/rules/delete',
                        type: 'POST',
                        data: JSON.stringify({ ids: selected }),
                        contentType: 'application/json',
                        success: function (res) {
                            if (res.success) {
                                layer.msg('删除成功');
                                fetchRules();
                            } else {
                                layer.msg('删除失败：' + res.error);
                            }
                        }
                    });
                    layer.close(index);
                });
            });

            // 打开新增/编辑规则窗口
            function openRuleEditor(id) {
                const editing = id ? '编辑规则' : '新增规则';
                const rule = id ? (window._rules?.find(r => r.id === id) || {}) : {};

                const formHtml = `
                    <div style="padding:16px;">
                        <div class="layui-form-item">
                            <label class="layui-form-label">触发条件</label>
                            <div class="layui-input-block">
                                <input class="layui-input" id="rule_trigger" value="${rule.trigger || ''}">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">回复内容</label>
                            <div class="layui-input-block">
                                <textarea class="layui-textarea" id="rule_reply">${rule.reply || ''}</textarea>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">匹配模式</label>
                            <div class="layui-input-block">
                                <select id="rule_mode">
                                    <option value="exact" ${rule.mode === 'exact' ? 'selected' : ''}>精确匹配</option>
                                    <option value="fuzzy" ${rule.mode === 'fuzzy' ? 'selected' : ''}>模糊匹配</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">是否启用</label>
                            <div class="layui-input-block">
                                <input type="checkbox" id="rule_enabled" ${rule.enabled ? 'checked' : ''}>
                            </div>
                        </div>
                        <button class="layui-btn" id="btn_save_rule">保存</button>
                    </div>`;

                layer.open({
                    type: 1,
                    title: editing,
                    area: ['400px', '480px'],
                    content: formHtml,
                    success: function (layero, index) {
                        $('#btn_save_rule').click(function () {
                            const data = {
                                id: id,
                                trigger: $('#rule_trigger').val(),
                                reply: $('#rule_reply').val(),
                                mode: $('#rule_mode').val(),
                                enabled: $('#rule_enabled').is(':checked')
                            };
                            $.ajax({
                                url: '/api/rules/save',
                                type: 'POST',
                                data: JSON.stringify(data),
                                contentType: 'application/json',
                                success: function (res) {
                                    if (res.success) {
                                        layer.msg('保存成功');
                                        layer.close(index);
                                        fetchRules();
                                    } else {
                                        layer.msg('保存失败：' + (res.error || '未知错误'));
                                    }
                                }
                            });
                        });
                    }
                });
            }

            // 新增按钮绑定
            $('#btn_add_rule').click(function () {
                openRuleEditor();  // 新增
            });

        });
    </script>
</body>

</html>