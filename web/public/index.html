<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>QQ 机器人 · 后台管理</title>
    <link rel="shortcut icon" href="./images/favicon.png">
    <!-- 使用 layui（与用户现有代码兼容） -->
    <link rel="stylesheet" href="./layui/css/layui.css">
    <style>
        body {
            background: #f5f7fa;
            margin: 0;
            font-family: "Microsoft Yahei", Arial, sans-serif
        }

        .top-bar {
            height: 60px;
            background: #fff;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 1px 0 rgba(0, 0, 0, .06)
        }

        .logo {
            height: 36px;
            margin-right: 12px
        }

        .app-title {
            font-size: 18px;
            color: #333;
            margin-right: 20px
        }

        .side {
            width: 240px;
            background: #fff;
            height: calc(100vh - 60px);
            box-shadow: 1px 0 0 rgba(0, 0, 0, .03);
            position: fixed;
            top: 60px;
            left: 0;
            overflow: auto
        }

        .content {
            margin-left: 260px;
            padding: 20px;
            min-height: calc(100vh - 60px)
        }

        .card {
            background: #fff;
            padding: 16px;
            border-radius: 6px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, .03);
        }

        .menu-item {
            padding: 12px 18px;
            cursor: pointer;
            color: #333
        }

        .menu-item.active {
            background: #edf2ff;
            color: #2f54eb
        }

        .toolbar {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .small {
            font-size: 13px
        }

        textarea {
            min-height: 120px
        }

        .muted {
            color: #999
        }

        .flex {
            display: flex;
            gap: 12px
        }

        .grow {
            flex: 1
        }

        .table-actions button {
            margin-right: 6px
        }

        .footer-note {
            font-size: 12px;
            color: #999;
            margin-top: 12px
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <img class="logo" src="./images/favicon.png" alt="logo">
        <div class="app-title">XYA QQ 机器人 · 管理后台</div>
        <div style="flex:1"></div>
        <div class="toolbar">
        </div>
    </div>

    <div class="side">
        <div class="menu-item active" data-view="dashboard">仪表盘</div>
        <div class="menu-item" data-view="messages">消息管理</div>
        <div class="menu-item" data-view="groups">群组管理</div>
        <div class="menu-item" data-view="users">用户管理</div>
        <div class="menu-item" data-view="send">发送测试/广播</div>
        <div class="menu-item" data-view="logs">系统日志</div>
        <div class="menu-item" data-view="settings">机器人设置</div>
        <div class="menu-item" data-view="devtools">开发者工具</div>
    </div>

    <div class="content">
        <!-- 仪表盘 -->
        <div id="view_dashboard" class="view card">
            <h3>仪表盘</h3>
            <div class="flex" style="margin-top:12px">
                <div style="width:260px" class="card small">
                    <div><strong id="stat_online_bot">机器人在线：--</strong></div>
                    <div class="muted small">当前连接状态</div>
                </div>
                <div class="card grow small">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <div><strong id="stat_msgs">收到消息：--</strong></div>
                            <div class="muted">最近的消息计数</div>
                        </div>
                        <div>
                            <button class="layui-btn layui-btn-sm" id="btn_reload_stats">刷新</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 消息管理 -->
        <div id="view_messages" class="view" style="display:none">
            <h3>消息管理</h3>
            <div class="card" style="margin-top:12px">
                <div style="margin-bottom:8px;display:flex;align-items:center;gap:8px">
                    <input type="text" id="q_msg" placeholder="按关键字搜索" class="layui-input" style="width:320px">
                    <button class="layui-btn layui-btn-sm" id="btn_search_msg">搜索</button>

                </div>
                <table class="layui-table">
                    <thead>
                        <tr>
                            <th style="width:60px">ID</th>
                            <th style="width:100px">用户</th>
                            <th style="max-width:400px; word-break:break-word;">内容</th>
                            <th style="width:140px">时间</th>
                            <th style="width:120px">操作</th>
                        </tr>
                    </thead>
                    <tbody id="msg_table_body">
                        <!-- 动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 群组管理 -->
        <div id="view_groups" class="view" style="display:none">
            <h3>群组管理</h3>
            <div class="card" style="margin-top:12px">
                <div style="display:flex;gap:8px;align-items:center">
                    <button class="layui-btn" id="btn_fetch_groups">获取群组</button>
                    <button class="layui-btn layui-btn-danger" id="btn_leave_group">退群（选中）</button>
                </div>
                <table class="layui-table" style="margin-top:8px">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="group_select_all"></th>
                            <th>群号</th>
                            <th>群名</th>
                            <th>人数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="groups_table_body"></tbody>
                </table>
            </div>
        </div>

        <!-- 用户管理 -->
        <div id="view_users" class="view" style="display:none">
            <h3>用户管理</h3>
            <div class="card" style="margin-top:12px">
                <table class="layui-table">
                    <thead>
                        <tr>
                            <th>UID</th>
                            <th>用户名</th>
                            <th>邮箱</th>
                            <th>权限</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="users_table_body"></tbody>
                </table>
            </div>
        </div>

        <!-- 发送测试/广播 -->
        <div id="view_send" class="view" style="display:none">
            <h3>发送测试 / 广播</h3>
            <div class="card" style="margin-top:12px">
                <div class="layui-form-item">
                    <label class="layui-form-label">目标（QQ/群/频道）</label>
                    <div class="layui-input-block"><input class="layui-input" id="send_target"
                            placeholder="例如：123456789 或 group:987654"></div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">消息</label>
                    <div class="layui-input-block"><textarea class="layui-textarea" id="send_message"
                            placeholder="请输入要发送的文本消息，支持 CQ 码"></textarea></div>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                    <button class="layui-btn" id="btn_send_once">发送</button>
                    <button class="layui-btn layui-btn-warm" id="btn_send_broadcast">广播（批量）</button>
                    <button class="layui-btn layui-btn-primary" id="btn_preview_cq">预览 CQ 码</button>
                </div>
                <div id="send_result" class="footer-note"></div>
            </div>
        </div>

        <!-- 日志 -->
        <div id="view_logs" class="view" style="display:none">
            <h3>系统日志</h3>
            <div class="card" style="margin-top:12px">
                <div style="margin-bottom:8px;display:flex;align-items:center;gap:8px">
                    <select id="log_level" class="layui-select" style="width:160px">
                        <option value="all">全部</option>
                        <option value="info">INFO</option>
                        <option value="warn">WARN</option>
                        <option value="error">ERROR</option>
                    </select>
                    <button class="layui-btn" id="btn_fetch_logs">获取日志</button>
                </div>
                <pre id="logs_area"
                    style="max-height:420px;overflow:auto;background:#111;color:#dfe6ff;padding:12px;border-radius:6px"></pre>
            </div>
        </div>

        <!-- 设置 -->
        <div id="view_settings" class="view" style="display:none">
            <h3>机器人设置</h3>
            <div class="card" style="margin-top:12px">
                <div class="layui-form-item">
                    <label class="layui-form-label">机器人名称</label>
                    <div class="layui-input-block"><input class="layui-input" id="setting_name"></div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">心跳间隔（秒）</label>
                    <div class="layui-input-block"><input class="layui-input" id="setting_heartbeat" type="number">
                    </div>
                </div>
                <div style="margin-top:8px"><button class="layui-btn" id="btn_save_settings">保存设置</button></div>
            </div>
        </div>

        <!-- 开发者工具 -->
        <div id="view_devtools" class="view" style="display:none">
            <h3>开发者工具</h3>
            <div class="card" style="margin-top:12px">
                <div><strong>模拟事件</strong></div>
                <div style="margin-top:8px">
                    <textarea id="dev_input_json" class="layui-textarea"
                        placeholder='示例: {"type":"message","from":123,"text":"你好"}'></textarea>
                    <div style="margin-top:8px"><button class="layui-btn" id="btn_send_sim">发送模拟事件</button></div>
                </div>
            </div>
        </div>

        <div style="height:36px"></div>
    </div>

    <script src="./js/jquery-2.1.4.min.js"></script>
    <script src="./layui/layui.js"></script>
    <script>
        // 简单前端逻辑：视图切换 / 调用后端 API（需要服务端实现对应接口）
        $(function () {
            // 菜单切换
            $('.menu-item').click(function () {
                $('.menu-item').removeClass('active');
                $(this).addClass('active');
                var view = $(this).data('view');
                $('.view').hide();
                $('#view_' + view).show();
            });

            // 加载消息列表
            $('#btn_refresh_msg, #btn_search_msg').click(loadMessages);
            function loadMessages() {
                var q = $('#q_msg').val() || '';
                $.get('/api/messages', { q: q }, function (res) {
                    var html = '';
                    (res || []).forEach(function (m, idx) {
                        html += '<tr>' +
                            '<td>' + m.id + '</td>' +
                            '<td>' + m.user + '</td>' +
                            '<td style="max-width:400px;word-break:break-word;overflow-wrap:break-word;">' + m.text + '</td>' +
                            '<td>' + m.time + '</td>' +
                            '<td class="table-actions">';
                        if (m.urls && m.urls.length > 0) {
                            html += '<div>';
                            m.urls.forEach(function (url, i) {
                                html += '<a href="javascript:;" class="copy-url" data-url="' + url + '" ' +
                                    'style="color:#52c41a;margin-right:5px;display:inline-block;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" ' +
                                    'title="' + url + '">复制链接</a>';
                            });
                            html += '</div>';
                        }
                        html += '</td></tr>';
                    });
                    $('#msg_table_body').html(html);
                    // 绑定点击事件
                    $('.copy-url').off('click').on('click', function () {
                        var url = $(this).data('url');
                        navigator.clipboard.writeText(url).then(function () {
                            layer.msg('已复制链接', { icon: 1 });
                        }).catch(function () {
                            layer.msg('复制失败', { icon: 2 });
                        });
                    });
                }).fail(function () {
                    layer.msg('获取消息失败', { icon: 0 });
                });
            }


            // 群组
            $('#btn_fetch_groups').click(function () {
                $.get('/api/groups', function (res) {
                    var html = '';
                    (res || []).forEach(function (g) {
                        html += '<tr>' +
                            '<td><input type="checkbox" class="group_check" value="' + g.id + '"></td>' +
                            '<td>' + g.id + '</td><td>' + g.name + '</td><td>' + g.count + '</td>' +
                            '<td><button class="layui-btn layui-btn-xs" onclick="openGroup(' + g.id + ')">管理</button></td>' +
                            '</tr>';
                    });
                    $('#groups_table_body').html(html);
                }).fail(function () { layer.msg('获取群列表失败', { icon: 0 }); });
            });
            $('#group_select_all').on('change', function () { $('.group_check').prop('checked', this.checked); });

            $('#btn_leave_group').click(function () {
                const selected = $('#groups_table_body input[type=checkbox]:checked')
                    .map((_, el) => $(el).val()) // ✅ 改这里
                    .get();

                if (selected.length === 0) {
                    return layer.msg('请先选择要退出的群组');
                }

                layer.confirm('确认要退出选中的 ' + selected.length + ' 个群组吗？', function (index) {
                    $.ajax({
                        url: '/api/groups/leave',
                        type: 'POST',
                        data: JSON.stringify({ group_ids: selected }),
                        contentType: 'application/json',
                        success: function (res) {
                            console.log(res);
                            if (res.success) {
                                layer.msg('已退出所选群组');
                                $('#btn_fetch_groups').click();
                            } else {
                                layer.msg('部分退群失败：' + (res.error || '未知错误'));
                            }
                        },
                        error: function () {
                            layer.msg('网络错误，无法退群');
                        }
                    });
                    layer.close(index);
                });
            });



            // 发送
            $('#btn_send_once').click(function () {
                var target = $('#send_target').val();
                var text = $('#send_message').val();
                if (!target || !text) { layer.msg('目标或消息为空', { icon: 0 }); return }
                $.post('/api/send', JSON.stringify({ target: target, text: text }), function (res) {
                    $('#send_result').text(JSON.stringify(res));
                    layer.msg('请求已发送');
                }, 'json').fail(function () { layer.msg('发送请求失败', { icon: 0 }); });
            });

            $('#btn_send_broadcast').click(function () {
                var text = $('#send_message').val();
                if (!text) { layer.msg('消息为空', { icon: 0 }); return }
                if (!confirm('确认发送广播给所有已订阅的对象吗？')) return;
                $.post('/api/broadcast', JSON.stringify({ text: text }), function (res) {
                    layer.msg(res.msg || '已请求广播');
                }, 'json').fail(function () { layer.msg('广播请求失败', { icon: 0 }); });
            });

            // 日志
            $('#btn_fetch_logs').click(function () {
                var level = $('#log_level').val();
                $.get('/api/logs', { level: level }, function (res) {
                    $('#logs_area').text((res || []).join('\n'));
                }).fail(function () { layer.msg('获取日志失败', { icon: 0 }); });
            });

            // 设置保存
            $('#btn_save_settings').click(function () {
                var data = { name: $('#setting_name').val(), heartbeat: Number($('#setting_heartbeat').val()) };
                $.ajax({ url: '/api/settings', type: 'POST', contentType: 'application/json', data: JSON.stringify(data), success: function (res) { layer.msg('保存成功', { icon: 1 }); }, error: function () { layer.msg('保存失败', { icon: 0 }); } });
            });

            // 仪表盘：自动轮询统计
            function fetchStats() {
                $.get('/api/stats', function (res) {
                    $('#stat_online_bot').text('机器人在线：' + (res.online ? '是' : '否'));
                    $('#stat_msgs').text('收到消息：' + (res.total || 0));
                }).fail(function () {
                    $('#stat_online_bot').text('机器人在线：未知（请求失败）');
                });
            }
            // 初次加载时执行一次
            fetchStats();
            // 每 10 秒轮询一次（可根据需求调整）
            setInterval(fetchStats, 10000);

            window.openGroup = function (id) {
                layer.msg('打开群组管理: ' + id);
            }

            // 模拟事件发送
            $('#btn_send_sim').click(function () {
                var txt = $('#dev_input_json').val();
                try { var obj = JSON.parse(txt); } catch (e) { layer.msg('JSON 解析错误', { icon: 0 }); return; }
                $.post('/api/dev/sim', JSON.stringify(obj), function (res) { layer.msg('已发送模拟事件', { icon: 1 }); }, 'json');
            });
        });

    </script>

    <!-- 说明：
    此页面为前端样板，依赖后端提供如下 REST 接口（示例）：
      POST /api/admin/login        -> {name,password} 返回 {ok, token, user}
      GET  /api/stats              -> 返回 {online, today_msgs}
      GET  /api/messages?q=...     -> 返回消息数组
      GET  /api/message/:id        -> 返回单条消息
      DELETE /api/message/:id
      GET  /api/groups
      POST /api/send               -> {target,text}
      POST /api/broadcast          -> {text}
      GET  /api/logs?level=...
      POST /api/settings           -> 保存设置
      POST /api/dev/sim            -> 接收模拟事件
    根据实际机器人后端实现调整接口与字段。
  -->
</body>

</html>